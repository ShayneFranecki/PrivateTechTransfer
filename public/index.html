<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Technology Transfer Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Fallback if ethers fails to load
        if (typeof ethers === 'undefined') {
            console.error('Ethers.js failed to load from CDN');
            document.body.innerHTML = '<div style="text-align:center;padding:50px;font-family:Arial;"><h2>Loading Error</h2><p>Failed to load ethers.js library. Please check your internet connection and try again.</p><button onclick="location.reload()">Reload Page</button></div>';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .connection-section {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .connect-btn, .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .connect-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .function-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            transition: transform 0.3s ease;
        }

        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .function-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #6c757d;
            font-weight: 500;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .checkbox-group input {
            margin-right: 8px;
            width: auto;
        }

        .result-section {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .result-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .feature-highlight {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .privacy-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            color: #6c757d;
        }

        .loading.show {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        .proposal-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .proposal-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Private Technology Transfer Platform</h1>
            <p>Confidential Technology Transfer Platform Based on Zama FHE Technology</p>
            <div class="privacy-badge">Complete Privacy Protection</div>
            <div class="privacy-badge">Homomorphic Encryption</div>
            <div class="privacy-badge">Zero Knowledge Proof</div>
        </div>

        <div class="main-content">
            <div class="connection-section">
                <h2>Wallet Connection</h2>
                <button id="connectWallet" class="connect-btn">Connect MetaMask</button>
                <div id="walletStatus" class="status disconnected">
                    Please connect wallet to use platform features
                </div>
                <div id="accountInfo" style="display: none;">
                    <p><strong>Account:</strong> <span id="accountAddress"></span></p>
                    <p><strong>Balance:</strong> <span id="accountBalance"></span> ETH</p>
                    <p><strong>Network:</strong> <span id="networkName"></span></p>
                </div>
            </div>

            <div class="feature-highlight">
                <h3>üåü Platform Features</h3>
                <p>Using cutting-edge FHE (Fully Homomorphic Encryption) technology to ensure that sensitive information such as technology asset prices and valuations remain encrypted throughout the entire transfer process, achieving true privacy protection.</p>
            </div>

            <div class="functions-grid">
                <!-- Submit Technology Asset -->
                <div class="function-card">
                    <h3>üì§ Submit Technology Asset</h3>
                    <div class="input-group">
                        <label>Price (Wei):</label>
                        <input type="number" id="techPrice" placeholder="Technology asset price">
                    </div>
                    <div class="input-group">
                        <label>Valuation (Wei):</label>
                        <input type="number" id="techValuation" placeholder="Technology valuation">
                    </div>
                    <div class="input-group">
                        <label>Public Description:</label>
                        <textarea id="techDescription" placeholder="Public description of the technology asset" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Confidential Information Hash:</label>
                        <input type="text" id="techConfidentialHash" placeholder="0x..." maxlength="66">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="isExclusive">
                        <label for="isExclusive">Exclusive Transfer</label>
                    </div>
                    <button class="action-btn" onclick="submitTechAsset()">Submit Technology Asset</button>
                    <div id="submitResult" style="display: none;"></div>
                </div>

                <!-- Technology Asset Management -->
                <div class="function-card">
                    <h3>üìã Technology Asset Management</h3>
                    <div class="input-group">
                        <label>Technology ID:</label>
                        <input type="number" id="manageTechId" placeholder="Enter technology asset ID">
                    </div>
                    <button class="action-btn" onclick="getTechAssetInfo()">View Details</button>
                    <button class="action-btn" onclick="approveTechAsset()">Approve Listing</button>
                    <button class="action-btn" onclick="listTechAsset()">List Asset</button>
                    <div class="result-section" id="techInfoResult" style="display: none;"></div>
                </div>

                <!-- Purchase and Proposals -->
                <div class="function-card">
                    <h3>üí∞ Purchase & Proposals</h3>
                    <div class="input-group">
                        <label>Technology ID:</label>
                        <input type="number" id="buyTechId" placeholder="Interested technology ID">
                    </div>
                    <button class="action-btn" onclick="registerInterest()">Register Purchase Interest</button>

                    <div class="input-group" style="margin-top: 15px;">
                        <label>Offer Price (Wei):</label>
                        <input type="number" id="offerPrice" placeholder="Your offer price">
                    </div>
                    <div class="input-group">
                        <label>Transfer Terms:</label>
                        <textarea id="transferTerms" placeholder="Transfer terms description" rows="2"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Confidential Terms Hash:</label>
                        <input type="text" id="confidentialTermsHash" placeholder="0x..." maxlength="66">
                    </div>
                    <button class="action-btn" onclick="submitTransferProposal()">Submit Transfer Proposal</button>

                    <div style="margin-top: 15px;">
                        <button class="action-btn" onclick="getProposalsForTech()">View Proposals</button>
                    </div>
                    <div id="proposalsResult" style="display: none;"></div>
                </div>

                <!-- Proposal Management -->
                <div class="function-card">
                    <h3>‚úÖ Proposal Management</h3>
                    <div class="input-group">
                        <label>Technology ID:</label>
                        <input type="number" id="proposalTechId" placeholder="Technology ID">
                    </div>
                    <div class="input-group">
                        <label>Proposal Index:</label>
                        <input type="number" id="proposalIndex" placeholder="Proposal index">
                    </div>
                    <button class="action-btn" onclick="acceptTransferProposal()">Accept Proposal</button>
                    <button class="action-btn" onclick="rejectTransferProposal()">Reject Proposal</button>
                    <div id="proposalManagementResult" style="display: none;"></div>
                </div>

                <!-- Evaluation System -->
                <div class="function-card">
                    <h3>üîç Evaluation System</h3>
                    <div class="input-group">
                        <label>Technology ID:</label>
                        <input type="number" id="evalTechId" placeholder="Technology ID to evaluate">
                    </div>
                    <div class="input-group">
                        <label>Score (0-100):</label>
                        <input type="number" id="evalScore" min="0" max="100" placeholder="Evaluation score">
                    </div>
                    <div class="input-group">
                        <label>Report Hash:</label>
                        <input type="text" id="evalReportHash" placeholder="0x..." maxlength="66">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="isConfidentialReport">
                        <label for="isConfidentialReport">Confidential Report</label>
                    </div>
                    <button class="action-btn" onclick="submitEvaluationReport()">Submit Evaluation Report</button>
                    <div id="evaluationResult" style="display: none;"></div>
                </div>

                <!-- Platform Management -->
                <div class="function-card">
                    <h3>‚öôÔ∏è Platform Management</h3>
                    <div class="input-group">
                        <label>Evaluator Address:</label>
                        <input type="text" id="evaluatorAddress" placeholder="0x...">
                    </div>
                    <button class="action-btn" onclick="authorizeEvaluator()">Authorize Evaluator</button>
                    <button class="action-btn" onclick="revokeEvaluator()">Revoke Evaluator</button>

                    <div class="input-group" style="margin-top: 15px;">
                        <label>New Fee Rate (Basis Points):</label>
                        <input type="number" id="newFeeRate" placeholder="e.g., 250 = 2.5%">
                    </div>
                    <button class="action-btn" onclick="updatePlatformFeeRate()">Update Fee Rate</button>

                    <div style="margin-top: 15px;">
                        <button class="action-btn" onclick="getPlatformStats()">Platform Statistics</button>
                    </div>
                    <div class="result-section" id="platformStatsResult" style="display: none;"></div>
                </div>

                <!-- User Assets -->
                <div class="function-card">
                    <h3>üë§ My Assets</h3>
                    <button class="action-btn" onclick="getMyTechAssets()">My Technology Assets</button>
                    <button class="action-btn" onclick="getMyInterests()">My Purchase Interests</button>
                    <div class="result-section" id="userAssetsResult" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <span>Transaction processing, please wait...</span>
        </div>
    </div>

    <script>
        // Contract configuration - Deployed on Sepolia Testnet
        const CONTRACT_ADDRESS = "0x589508FF5C3628e9aB99A80c7e3e6D78D1B9e54d"; // PrivateTechTransfer Contract
        const CONTRACT_ABI = [
            "function submitTechAsset(uint64 _price, uint32 _valuation, string _publicDescription, bytes32 _confidentialHash, bool _isExclusive)",
            "function getTechAssetInfo(uint256 _techId) view returns (uint256, address, string, uint8, uint256, bool, uint256)",
            "function registerBuyerInterest(uint256 _techId)",
            "function submitTransferProposal(uint256 _techId, uint64 _offerPrice, string _terms, bytes32 _confidentialTermsHash)",
            "function acceptTransferProposal(uint256 _techId, uint256 _proposalIndex)",
            "function submitEvaluationReport(uint256 _techId, uint32 _score, bytes32 _reportHash, bool _isConfidential)",
            "function authorizeEvaluator(address _evaluator)",
            "function revokeEvaluatorAuthorization(address _evaluator)",
            "function updatePlatformFeeRate(uint256 _newFeeRate)",
            "function approveTechAsset(uint256 _techId)",
            "function listTechAsset(uint256 _techId)",
            "function getOwnerTechAssets(address _owner) view returns (uint256[])",
            "function getBuyerInterests(address _buyer) view returns (uint256[])",
            "function getTechProposalCount(uint256 _techId) view returns (uint256)",
            "function totalTechCount() view returns (uint256)",
            "function platformFeeRate() view returns (uint256)",
            "function platformOwner() view returns (address)",
            "function authorizedEvaluators(address) view returns (bool)",
            "event TechAssetSubmitted(uint256 indexed techId, address indexed owner, uint256 timestamp)",
            "event TechAssetApproved(uint256 indexed techId, address indexed approver, uint256 timestamp)",
            "event TechAssetListed(uint256 indexed techId, address indexed owner)",
            "event TransferProposalSubmitted(uint256 indexed techId, address indexed buyer, uint256 proposalIndex)",
            "event TechAssetTransferred(uint256 indexed techId, address indexed from, address indexed to, uint256 timestamp)",
            "event EvaluationReportSubmitted(uint256 indexed techId, address indexed evaluator)",
            "event BuyerInterestRegistered(uint256 indexed techId, address indexed buyer)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    showLoading(true);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();

                    // Check network
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network);

                    // Initialize contract
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    updateWalletUI();
                    showLoading(false);
                } catch (error) {
                    console.error('Wallet connection failed:', error);
                    showError('Wallet connection failed: ' + error.message);
                    showLoading(false);
                }
            } else {
                showError('Please install MetaMask wallet');
            }
        }

        // Update wallet UI
        async function updateWalletUI() {
            if (signer && userAddress) {
                document.getElementById('walletStatus').className = 'status connected';
                document.getElementById('walletStatus').textContent = 'Wallet Connected';

                document.getElementById('accountAddress').textContent = userAddress;
                const balance = await provider.getBalance(userAddress);
                document.getElementById('accountBalance').textContent = ethers.utils.formatEther(balance);

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name || `Chain ID: ${network.chainId}`;

                document.getElementById('accountInfo').style.display = 'block';
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').disabled = true;
            }
        }

        // Show loading state
        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // Show error message
        function showError(message) {
            console.error(message);
            alert('Error: ' + message);
        }

        // Show success message
        function showSuccess(message, elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="success-message">${message}</div>`;
                element.style.display = 'block';
            } else {
                alert('Success: ' + message);
            }
        }

        // Validate contract connection
        function validateContract() {
            if (!contract) {
                showError('Contract not connected. Please check contract address and network.');
                return false;
            }
            return true;
        }

        // Submit technology asset
        async function submitTechAsset() {
            if (!validateContract()) return;

            try {
                showLoading(true);

                const price = document.getElementById('techPrice').value;
                const valuation = document.getElementById('techValuation').value;
                const description = document.getElementById('techDescription').value;
                const confidentialHash = document.getElementById('techConfidentialHash').value;
                const isExclusive = document.getElementById('isExclusive').checked;

                if (!price || !valuation || !description || !confidentialHash) {
                    showError('Please fill in all required fields');
                    showLoading(false);
                    return;
                }

                if (!confidentialHash.startsWith('0x') || confidentialHash.length !== 66) {
                    showError('Invalid hash format. Must be 0x followed by 64 characters');
                    showLoading(false);
                    return;
                }

                const tx = await contract.submitTechAsset(
                    price,
                    valuation,
                    description,
                    confidentialHash,
                    isExclusive
                );

                await tx.wait();
                showSuccess(`Technology asset submitted successfully! Transaction hash: ${tx.hash}`, 'submitResult');

                // Clear form
                document.getElementById('techPrice').value = '';
                document.getElementById('techValuation').value = '';
                document.getElementById('techDescription').value = '';
                document.getElementById('techConfidentialHash').value = '';
                document.getElementById('isExclusive').checked = false;

                showLoading(false);
            } catch (error) {
                console.error('Submission failed:', error);
                showError('Submission failed: ' + error.message);
                showLoading(false);
            }
        }

        // Get technology asset information
        async function getTechAssetInfo() {
            if (!validateContract()) return;

            try {
                const techId = document.getElementById('manageTechId').value;
                if (!techId) {
                    showError('Please enter technology ID');
                    return;
                }

                const info = await contract.getTechAssetInfo(techId);
                const resultDiv = document.getElementById('techInfoResult');

                const statusNames = ['Submitted', 'Under Review', 'Approved', 'Listed', 'In Negotiation', 'Transferred', 'Rejected'];

                resultDiv.innerHTML = `
                    <h4>Technology Asset #${techId} Information</h4>
                    <p><strong>ID:</strong> ${info[0]}</p>
                    <p><strong>Owner:</strong> ${info[1]}</p>
                    <p><strong>Description:</strong> ${info[2]}</p>
                    <p><strong>Status:</strong> ${statusNames[info[3]] || 'Unknown'}</p>
                    <p><strong>Submission Time:</strong> ${new Date(info[4] * 1000).toLocaleString()}</p>
                    <p><strong>Exclusive Transfer:</strong> ${info[5] ? 'Yes' : 'No'}</p>
                    <p><strong>Interested Buyers:</strong> ${info[6]}</p>
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Failed to get information:', error);
                showError('Failed to get information: ' + error.message);
            }
        }

        // Approve technology asset (platform owner only)
        async function approveTechAsset() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const techId = document.getElementById('manageTechId').value;

                if (!techId) {
                    showError('Please enter technology ID');
                    showLoading(false);
                    return;
                }

                const tx = await contract.approveTechAsset(techId);
                await tx.wait();

                showSuccess(`Technology asset #${techId} approved successfully!`, 'techInfoResult');
                showLoading(false);
            } catch (error) {
                console.error('Approval failed:', error);
                showError('Approval failed: ' + error.message);
                showLoading(false);
            }
        }

        // List technology asset
        async function listTechAsset() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const techId = document.getElementById('manageTechId').value;

                if (!techId) {
                    showError('Please enter technology ID');
                    showLoading(false);
                    return;
                }

                const tx = await contract.listTechAsset(techId);
                await tx.wait();

                showSuccess(`Technology asset #${techId} listed successfully!`, 'techInfoResult');
                showLoading(false);
            } catch (error) {
                console.error('Listing failed:', error);
                showError('Listing failed: ' + error.message);
                showLoading(false);
            }
        }

        // Register purchase interest
        async function registerInterest() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const techId = document.getElementById('buyTechId').value;

                if (!techId) {
                    showError('Please enter technology ID');
                    showLoading(false);
                    return;
                }

                const tx = await contract.registerBuyerInterest(techId);
                await tx.wait();

                showSuccess('Purchase interest registered successfully!');
                showLoading(false);
            } catch (error) {
                console.error('Registration failed:', error);
                showError('Registration failed: ' + error.message);
                showLoading(false);
            }
        }

        // Submit transfer proposal
        async function submitTransferProposal() {
            if (!validateContract()) return;

            try {
                showLoading(true);

                const techId = document.getElementById('buyTechId').value;
                const offerPrice = document.getElementById('offerPrice').value;
                const terms = document.getElementById('transferTerms').value;
                const confidentialTermsHash = document.getElementById('confidentialTermsHash').value;

                if (!techId || !offerPrice || !terms || !confidentialTermsHash) {
                    showError('Please fill in all required fields');
                    showLoading(false);
                    return;
                }

                if (!confidentialTermsHash.startsWith('0x') || confidentialTermsHash.length !== 66) {
                    showError('Invalid hash format. Must be 0x followed by 64 characters');
                    showLoading(false);
                    return;
                }

                const tx = await contract.submitTransferProposal(
                    techId,
                    offerPrice,
                    terms,
                    confidentialTermsHash
                );

                await tx.wait();
                showSuccess(`Transfer proposal submitted successfully! Transaction hash: ${tx.hash}`);

                // Clear form
                document.getElementById('offerPrice').value = '';
                document.getElementById('transferTerms').value = '';
                document.getElementById('confidentialTermsHash').value = '';

                showLoading(false);
            } catch (error) {
                console.error('Proposal submission failed:', error);
                showError('Proposal submission failed: ' + error.message);
                showLoading(false);
            }
        }

        // Accept transfer proposal
        async function acceptTransferProposal() {
            if (!validateContract()) return;

            try {
                showLoading(true);

                const techId = document.getElementById('proposalTechId').value;
                const proposalIndex = document.getElementById('proposalIndex').value;

                if (!techId || proposalIndex === '') {
                    showError('Please enter technology ID and proposal index');
                    showLoading(false);
                    return;
                }

                const tx = await contract.acceptTransferProposal(techId, proposalIndex);
                await tx.wait();

                showSuccess(`Proposal accepted successfully! Transaction hash: ${tx.hash}`, 'proposalManagementResult');
                showLoading(false);
            } catch (error) {
                console.error('Proposal acceptance failed:', error);
                showError('Proposal acceptance failed: ' + error.message);
                showLoading(false);
            }
        }

        // Submit evaluation report
        async function submitEvaluationReport() {
            if (!validateContract()) return;

            try {
                showLoading(true);

                const techId = document.getElementById('evalTechId').value;
                const score = document.getElementById('evalScore').value;
                const reportHash = document.getElementById('evalReportHash').value;
                const isConfidential = document.getElementById('isConfidentialReport').checked;

                if (!techId || !score || !reportHash) {
                    showError('Please fill in all required fields');
                    showLoading(false);
                    return;
                }

                if (!reportHash.startsWith('0x') || reportHash.length !== 66) {
                    showError('Invalid hash format. Must be 0x followed by 64 characters');
                    showLoading(false);
                    return;
                }

                const tx = await contract.submitEvaluationReport(
                    techId,
                    score,
                    reportHash,
                    isConfidential
                );

                await tx.wait();
                showSuccess(`Evaluation report submitted successfully! Transaction hash: ${tx.hash}`, 'evaluationResult');

                // Clear form
                document.getElementById('evalTechId').value = '';
                document.getElementById('evalScore').value = '';
                document.getElementById('evalReportHash').value = '';
                document.getElementById('isConfidentialReport').checked = false;

                showLoading(false);
            } catch (error) {
                console.error('Evaluation submission failed:', error);
                showError('Evaluation submission failed: ' + error.message);
                showLoading(false);
            }
        }

        // Authorize evaluator
        async function authorizeEvaluator() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const evaluatorAddress = document.getElementById('evaluatorAddress').value;

                if (!evaluatorAddress || !ethers.utils.isAddress(evaluatorAddress)) {
                    showError('Please enter a valid evaluator address');
                    showLoading(false);
                    return;
                }

                const tx = await contract.authorizeEvaluator(evaluatorAddress);
                await tx.wait();

                showSuccess(`Evaluator ${evaluatorAddress} authorized successfully!`);
                showLoading(false);
            } catch (error) {
                console.error('Authorization failed:', error);
                showError('Authorization failed: ' + error.message);
                showLoading(false);
            }
        }

        // Revoke evaluator authorization
        async function revokeEvaluator() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const evaluatorAddress = document.getElementById('evaluatorAddress').value;

                if (!evaluatorAddress || !ethers.utils.isAddress(evaluatorAddress)) {
                    showError('Please enter a valid evaluator address');
                    showLoading(false);
                    return;
                }

                const tx = await contract.revokeEvaluatorAuthorization(evaluatorAddress);
                await tx.wait();

                showSuccess(`Evaluator authorization for ${evaluatorAddress} revoked successfully!`);
                showLoading(false);
            } catch (error) {
                console.error('Revocation failed:', error);
                showError('Revocation failed: ' + error.message);
                showLoading(false);
            }
        }

        // Update platform fee rate
        async function updatePlatformFeeRate() {
            if (!validateContract()) return;

            try {
                showLoading(true);
                const newFeeRate = document.getElementById('newFeeRate').value;

                if (!newFeeRate || newFeeRate < 0 || newFeeRate > 1000) {
                    showError('Please enter a valid fee rate (0-1000 basis points)');
                    showLoading(false);
                    return;
                }

                const tx = await contract.updatePlatformFeeRate(newFeeRate);
                await tx.wait();

                showSuccess(`Platform fee rate updated to ${newFeeRate} basis points (${newFeeRate/100}%)`);
                showLoading(false);
            } catch (error) {
                console.error('Fee rate update failed:', error);
                showError('Fee rate update failed: ' + error.message);
                showLoading(false);
            }
        }

        // Get platform statistics
        async function getPlatformStats() {
            if (!validateContract()) return;

            try {
                const totalTech = await contract.totalTechCount();
                const feeRate = await contract.platformFeeRate();
                const platformOwner = await contract.platformOwner();
                const isAuthorizedEvaluator = await contract.authorizedEvaluators(userAddress);

                const resultDiv = document.getElementById('platformStatsResult');
                resultDiv.innerHTML = `
                    <h4>Platform Statistics</h4>
                    <p><strong>Total Technology Assets:</strong> ${totalTech}</p>
                    <p><strong>Platform Fee Rate:</strong> ${feeRate} basis points (${feeRate/100}%)</p>
                    <p><strong>Platform Owner:</strong> ${platformOwner}</p>
                    <p><strong>You are Platform Owner:</strong> ${platformOwner.toLowerCase() === userAddress.toLowerCase() ? 'Yes' : 'No'}</p>
                    <p><strong>You are Authorized Evaluator:</strong> ${isAuthorizedEvaluator ? 'Yes' : 'No'}</p>
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Failed to get statistics:', error);
                showError('Failed to get statistics: ' + error.message);
            }
        }

        // Get my technology assets
        async function getMyTechAssets() {
            if (!validateContract()) return;

            try {
                const assets = await contract.getOwnerTechAssets(userAddress);
                const resultDiv = document.getElementById('userAssetsResult');

                if (assets.length === 0) {
                    resultDiv.innerHTML = `
                        <h4>My Technology Assets</h4>
                        <p>You don't own any technology assets yet.</p>
                    `;
                } else {
                    let assetList = '<h4>My Technology Assets</h4><ul>';
                    for (let asset of assets) {
                        assetList += `<li>Technology Asset #${asset}</li>`;
                    }
                    assetList += '</ul>';
                    resultDiv.innerHTML = assetList;
                }
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Failed to get assets:', error);
                showError('Failed to get assets: ' + error.message);
            }
        }

        // Get my purchase interests
        async function getMyInterests() {
            if (!validateContract()) return;

            try {
                const interests = await contract.getBuyerInterests(userAddress);
                const resultDiv = document.getElementById('userAssetsResult');

                if (interests.length === 0) {
                    resultDiv.innerHTML = `
                        <h4>My Purchase Interests</h4>
                        <p>You haven't registered interest in any technology assets yet.</p>
                    `;
                } else {
                    let interestList = '<h4>My Purchase Interests</h4><ul>';
                    for (let interest of interests) {
                        interestList += `<li>Technology Asset #${interest}</li>`;
                    }
                    interestList += '</ul>';
                    resultDiv.innerHTML = interestList;
                }
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Failed to get interests:', error);
                showError('Failed to get interests: ' + error.message);
            }
        }

        // Get proposals for technology
        async function getProposalsForTech() {
            if (!validateContract()) return;

            try {
                const techId = document.getElementById('buyTechId').value;
                if (!techId) {
                    showError('Please enter technology ID');
                    return;
                }

                const proposalCount = await contract.getTechProposalCount(techId);
                const resultDiv = document.getElementById('proposalsResult');

                resultDiv.innerHTML = `
                    <h4>Proposals for Technology Asset #${techId}</h4>
                    <p><strong>Total Proposals:</strong> ${proposalCount}</p>
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Failed to get proposals:', error);
                showError('Failed to get proposals: ' + error.message);
            }
        }

        // Placeholder for reject proposal (not implemented in contract)
        function rejectTransferProposal() {
            showError('Reject proposal function is not implemented in the current contract version');
        }

        // Page load initialization
        window.addEventListener('load', async () => {
            // Check if wallet is already connected
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            }

            // Bind wallet connection button
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
        });

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>